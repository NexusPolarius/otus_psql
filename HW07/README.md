# Механизм блокировок

## Подготовка к выполнению ДЗ
Создана ВМ в VirtualBox с ОС Ubuntu 20.04. Установлен PostgreSQL 15 с дефолтными настройками.

## Выполнение ДЗ

1. Настройте сервер так, чтобы в журнал сообщений сбрасывалась информация о блокировках, удерживаемых более 200 миллисекунд. Воспроизведите ситуацию, при которой в журнале появятся такие сообщения.
    * настраиваем сервер:
	
      ```locks=# ALTER SYSTEM SET log_lock_waits = on;```
	  
	  ```locks=# ALTER SYSTEM SET deadlock_timeout = 200;```
	  
	  ```locks=# SELECT pg_reload_conf();```
	
    * моделируем ситуацию:

Создал таблицу и заполнил ее данными

```CREATE TABLE accounts(acc_no integer PRIMARY KEY, amount numeric);```

```INSERT INTO accounts VALUES (1,1000.00), (2,2000.00), (3,3000.00);```

Начал апдейт в первой сесси

```BEGIN;```

```UPDATE accounts SET amount = amount - 100.00 WHERE acc_no = 1;```
   
Начал апдейт во второй сесси

```BEGIN;```

```UPDATE accounts SET amount = amount + 100.00 WHERE acc_no = 1;```
   
Второй апдейт заблокирован и через 200 миллисекунд в журнал сообщений добавится об этом запись

<img src="/HW07/xxx/1.PNG" alt="lock1.png" /> 


2. Смоделируйте ситуацию обновления одной и той же строки тремя командами UPDATE в разных сеансах. Изучите возникшие блокировки в представлении pg_locks и убедитесь, что все они понятны. Пришлите список блокировок и объясните, что значит каждая.



3. Воспроизведите взаимоблокировку трех транзакций. Можно ли разобраться в ситуации постфактум, изучая журнал сообщений?



4. Могут ли две транзакции, выполняющие единственную команду UPDATE одной и той же таблицы (без where), заблокировать друг друга?


